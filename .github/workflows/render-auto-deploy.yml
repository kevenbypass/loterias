name: Render Auto Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  trigger-render:
    runs-on: ubuntu-latest

    steps:
      - name: Validate deploy hook configuration
        env:
          RENDER_DEPLOY_HOOK_URL_FRONTEND: ${{ secrets.RENDER_DEPLOY_HOOK_URL_FRONTEND }}
          RENDER_DEPLOY_HOOK_URL_BACKEND: ${{ secrets.RENDER_DEPLOY_HOOK_URL_BACKEND }}
          RENDER_WEBHOOK: ${{ secrets.RENDER_WEBHOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL_FRONTEND" ] && [ -z "$RENDER_DEPLOY_HOOK_URL_BACKEND" ] && [ -z "$RENDER_WEBHOOK" ]; then
            echo "::warning::No Render deploy hook secret found. Configure RENDER_DEPLOY_HOOK_URL_FRONTEND and/or RENDER_DEPLOY_HOOK_URL_BACKEND (or legacy RENDER_WEBHOOK)."
          fi

      - name: Trigger frontend deploy hook
        env:
          HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL_FRONTEND }}
        run: |
          if [ -z "$HOOK_URL" ]; then
            echo "Frontend deploy hook not configured; skipping."
            exit 0
          fi
          status="$(curl -sS -o /dev/null -w "%{http_code}" -X POST "$HOOK_URL" || echo "000")"
          if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
            echo "Frontend deploy hook accepted (HTTP $status)."
          else
            echo "::warning::Frontend deploy hook returned HTTP $status."
          fi

      - name: Trigger backend deploy hook
        env:
          HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL_BACKEND }}
        run: |
          if [ -z "$HOOK_URL" ]; then
            echo "Backend deploy hook not configured; skipping."
            exit 0
          fi
          status="$(curl -sS -o /dev/null -w "%{http_code}" -X POST "$HOOK_URL" || echo "000")"
          if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
            echo "Backend deploy hook accepted (HTTP $status)."
          else
            echo "::warning::Backend deploy hook returned HTTP $status."
          fi

      - name: Trigger legacy deploy hook
        env:
          RENDER_DEPLOY_HOOK_URL_FRONTEND: ${{ secrets.RENDER_DEPLOY_HOOK_URL_FRONTEND }}
          RENDER_DEPLOY_HOOK_URL_BACKEND: ${{ secrets.RENDER_DEPLOY_HOOK_URL_BACKEND }}
          RENDER_WEBHOOK: ${{ secrets.RENDER_WEBHOOK }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK_URL_FRONTEND" ] || [ -n "$RENDER_DEPLOY_HOOK_URL_BACKEND" ]; then
            echo "Legacy deploy hook skipped because dedicated frontend/backend hooks are configured."
            exit 0
          fi
          if [ -z "$RENDER_WEBHOOK" ]; then
            echo "Legacy deploy hook not configured; skipping."
            exit 0
          fi
          HOOK_URL="$RENDER_WEBHOOK"
          status="$(curl -sS -o /dev/null -w "%{http_code}" -X POST "$HOOK_URL" || echo "000")"
          if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
            echo "Legacy deploy hook accepted (HTTP $status)."
          else
            echo "::warning::Legacy deploy hook returned HTTP $status."
          fi
